<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TikTok Follower Goal Widget</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800;900&display=swap" rel="stylesheet">
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –∫–ª–∏–µ–Ω—Ç—Å–∫—É—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É Socket.IO -->
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            background-color: transparent; 
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        body:not(.obs-mode) {
            background-color: #0f0f13;
            background-image: radial-gradient(circle at 50% 50%, #1a1a24 0%, #0f0f13 100%);
        }

        .glass-panel {
            background: rgba(20, 20, 25, 0.7);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5), inset 0 0 0 1px rgba(255,255,255,0.05);
        }

        .text-tiktok {
            background: linear-gradient(90deg, #00f2fe 0%, #fe0979 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .bg-tiktok {
            background: linear-gradient(135deg, #00f2fe 0%, #fe0979 100%);
        }

        @keyframes pulse-glow {
            0%, 100% { text-shadow: 0 0 10px rgba(254, 9, 121, 0.2); transform: scale(1); }
            50% { text-shadow: 0 0 20px rgba(254, 9, 121, 0.6); transform: scale(1.05); }
        }
        .animate-goal {
            animation: pulse-glow 2s infinite;
        }

        .alert-active {
            opacity: 1 !important;
            transform: translateY(0) scale(1) !important;
            pointer-events: auto !important;
        }
        
        .alert-bg {
            background: linear-gradient(135deg, rgba(0, 242, 254, 0.95), rgba(254, 9, 121, 0.95));
            backdrop-filter: blur(10px);
        }

        .promo-bg {
            background: rgba(10, 10, 15, 0.9);
            border: 2px solid #fe0979;
            box-shadow: 0 0 30px rgba(254, 9, 121, 0.4);
            backdrop-filter: blur(10px);
        }

        .pop-animation {
            animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        @keyframes shake {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-5deg); }
            75% { transform: rotate(5deg); }
        }
        .animate-shake {
            animation: shake 0.5s ease-in-out infinite;
        }
    </style>
</head>
<body class="text-white antialiased">

    <!-- –≠–ö–†–ê–ù –ù–ê–°–¢–†–û–ô–ö–ò -->
    <div id="setupScreen" class="hidden flex-col items-center justify-center glass-panel p-8 rounded-3xl w-80 text-center relative overflow-hidden">
        <h2 class="text-xl font-bold mb-2 relative z-10">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–∏–¥–∂–µ—Ç–∞</h2>
        <p class="text-xs text-gray-400 mb-6 relative z-10">–í–≤–µ–¥–∏—Ç–µ –≤–∞—à TikTok —é–∑–µ—Ä–Ω–µ–π–º</p>
        <div class="relative w-full mb-4 z-10">
            <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 font-bold">@</span>
            <input type="text" id="usernameInput" placeholder="username" class="w-full bg-black/50 border border-gray-600 rounded-xl py-3 pl-8 pr-4 text-white focus:outline-none focus:border-[#00f2fe]">
        </div>
        <button onclick="startWidget()" class="w-full bg-tiktok text-white font-bold py-3 rounded-xl shadow-lg hover:shadow-[0_0_20px_rgba(254,9,121,0.5)] transition-all">
            –°–æ–∑–¥–∞—Ç—å –≤–∏–¥–∂–µ—Ç
        </button>
    </div>

    <!-- –û–°–ù–û–í–ù–û–ô –í–ò–î–ñ–ï–¢ (–î–ª—è OBS) -->
    <div id="widgetContainer" class="hidden relative w-80 h-32 glass-panel rounded-3xl overflow-hidden shadow-2xl transition-all duration-300">
        <div class="absolute -top-10 -left-10 w-40 h-40 bg-[#00f2fe] rounded-full mix-blend-screen filter blur-[70px] opacity-30"></div>
        <div class="absolute -bottom-10 -right-10 w-40 h-40 bg-[#fe0979] rounded-full mix-blend-screen filter blur-[70px] opacity-30"></div>

        <div class="relative z-10 h-full w-full flex flex-col items-center justify-center p-4">
            <div class="flex items-center gap-2 mb-1">
                <span class="text-tiktok font-black text-sm tracking-widest uppercase drop-shadow-md">–¶–ï–õ–¨ –ü–û –ü–û–î–ü–ò–°–ß–ò–ö–ê–ú</span>
            </div>
            <div class="flex items-baseline gap-3 mt-1">
                <span id="currentFollowers" class="text-6xl font-black text-white drop-shadow-[0_0_15px_rgba(255,255,255,0.4)] transition-all duration-200">0</span>
                <span class="text-gray-500 text-3xl font-light">/</span>
                <span id="goalFollowers" class="text-5xl font-bold text-tiktok animate-goal">1</span>
            </div>
        </div>

        <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–æ–≤–æ–º –ø–æ–¥–ø–∏—Å—á–∏–∫–µ (–° –†–ï–ê–õ–¨–ù–û–ô –ê–í–û–ô, –±–µ–∑ –Ω–∞–¥–ø–∏—Å–∏ "—Ü–µ–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞") -->
        <div id="newSubscriberAlert" class="absolute inset-0 alert-bg flex flex-col items-center justify-center opacity-0 transform translate-y-8 scale-95 pointer-events-none transition-all duration-400 ease-out z-50 rounded-3xl">
            <div class="flex items-center gap-4 z-10">
                <img id="subAvatar" src="https://api.dicebear.com/7.x/avataaars/svg?seed=1" class="w-16 h-16 rounded-full border-2 border-white shadow-lg bg-white/20 object-cover" alt="Avatar">
                <div class="flex flex-col">
                    <span class="text-white/80 text-xs font-bold uppercase tracking-wider mb-0.5">–ù–æ–≤—ã–π –ø–æ–¥–ø–∏—Å—á–∏–∫!</span>
                    <span id="subName" class="text-white font-black text-xl drop-shadow-md leading-tight">...</span>
                </div>
            </div>
        </div>

        <!-- –ê–Ω–∏–º–∞—Ü–∏—è —Ä–∞–∑ –≤ 2 –º–∏–Ω—É—Ç—ã -->
        <div id="promoAlert" class="absolute inset-0 promo-bg flex flex-col items-center justify-center opacity-0 transform scale-110 pointer-events-none transition-all duration-500 ease-out z-40 rounded-3xl p-3 text-center">
            <div class="text-3xl mb-1 animate-shake">üî•</div>
            <div class="text-white font-black text-[15px] drop-shadow-lg tracking-wide uppercase leading-tight">
                –†–µ–±—è—Ç–∞, –æ—Å—Ç–∞–ª–∞—Å—å <span class="text-tiktok text-xl">1</span> –ø–æ–¥–ø–∏—Å–∫–∞!
            </div>
            <div class="text-gray-300 text-xs font-semibold mt-1 bg-white/10 px-3 py-1 rounded-full">
                –ü–æ–º–æ–≥–∏—Ç–µ –∑–∞–∫—Ä—ã—Ç—å —Ü–µ–ª—å! üéØ
            </div>
        </div>
    </div>

    <script>
        let username = "";
        let currentCount = 0;
        
        // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ WebSocket —Å–µ—Ä–≤–µ—Ä—É
        const socket = io();

        const setupScreen = document.getElementById('setupScreen');
        const widgetContainer = document.getElementById('widgetContainer');
        const currentFollowersEl = document.getElementById('currentFollowers');
        const goalFollowersEl = document.getElementById('goalFollowers');
        const alertOverlay = document.getElementById('newSubscriberAlert');
        const promoAlert = document.getElementById('promoAlert');
        const subAvatarEl = document.getElementById('subAvatar');
        const subNameEl = document.getElementById('subName');

        const urlParams = new URLSearchParams(window.location.search);
        const urlUser = urlParams.get('user');

        if (urlUser) {
            document.body.classList.add('obs-mode');
            startWidget(urlUser);
        } else {
            setupScreen.classList.remove('hidden');
            setupScreen.classList.add('flex');
        }

        function startWidget(customUser = null) {
            username = customUser || document.getElementById('usernameInput').value.trim();
            if (!username) return;
            username = username.replace('@', '');

            setupScreen.classList.add('hidden');
            setupScreen.classList.remove('flex');
            widgetContainer.classList.remove('hidden');

            // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ–µ —á–∏—Å–ª–æ
            fetchInitialData();
            
            // 2. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–µ—Ä–≤–µ—Ä—É –∫–æ–º–∞–Ω–¥—É "–°–ª—É—à–∞—Ç—å —ç—Ç–æ—Ç —Å—Ç—Ä–∏–º"
            socket.emit('set_username', username);

            // 3. –ó–∞–ø—É—Å–∫–∞–µ–º —Ñ–æ–Ω–æ–≤—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ —Å–ª—É—á–∞–π –æ—Ç–ø–∏—Å–æ–∫ (–∫–∞–∂–¥—ã–µ 15 —Å–µ–∫)
            setInterval(checkFollowers, 15000); 

            // 4. –ó–∞–ø—É—Å–∫ –∞–Ω–∏–º–∞—Ü–∏–∏ —Å –ø—Ä–∏–∑—ã–≤–æ–º –∫–∞–∂–¥—ã–µ 2 –º–∏–Ω—É—Ç—ã
            setInterval(showPromoAnimation, 120000);
        }

        // === –†–ï–ê–õ-–¢–ê–ô–ú –°–õ–£–®–ê–¢–ï–õ–¨ ===
        // –°–µ—Ä–≤–µ—Ä –ø—Ä–∏—à–ª–µ—Ç —ç—Ç–æ —Å–æ–±—ã—Ç–∏–µ –¢–û–õ–¨–ö–û –µ—Å–ª–∏ —Å–µ–π—á–∞—Å –∏–¥–µ—Ç –ø—Ä—è–º–æ–π —ç—Ñ–∏—Ä –∏ –∫—Ç–æ-—Ç–æ –ø–æ–¥–ø–∏—Å–∞–ª—Å—è
        socket.on('new_subscriber_live', (data) => {
            console.log("–†–µ–∞–ª—å–Ω—ã–π –ø–æ–¥–ø–∏—Å—á–∏–∫ —Å —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏!", data);
            
            // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ (—Ç–∞–∫ –∫–∞–∫ –∑–Ω–∞–µ–º, —á—Ç–æ –∫—Ç–æ-—Ç–æ –ø–æ–¥–ø–∏—Å–∞–ª—Å—è)
            currentCount++;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∞–ª—å–Ω—É—é –∞–≤—É –∏ –Ω–∏–∫
            triggerRealSubscriberEvent(data.avatar, data.nickname);
        });

        async function fetchInitialData() {
            try {
                const response = await fetch(`/api/followers/${username}`);
                const data = await response.json();
                if (data.followers !== undefined) {
                    currentCount = data.followers;
                    updateNumbers(currentCount);
                }
            } catch (err) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:", err);
                updateNumbers(0);
            }
        }

        // –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –æ–±—â–µ–µ —á–∏—Å–ª–æ –≤ —Ñ–æ–Ω–µ
        async function checkFollowers() {
            try {
                const response = await fetch(`/api/followers/${username}`);
                const data = await response.json();
                
                if (data.followers !== undefined) {
                    // –ï—Å–ª–∏ —á–∏—Å–ª–æ –≤—ã—Ä–æ—Å–ª–æ –∫–∞–∫-—Ç–æ –≤–Ω–µ —ç—Ñ–∏—Ä–∞
                    if (data.followers > currentCount) {
                        currentCount = data.followers;
                        updateNumbers(currentCount);
                    } else if (data.followers < currentCount) {
                        currentCount = data.followers;
                        updateNumbers(currentCount);
                    }
                }
            } catch (err) {}
        }

        function updateNumbers(count) {
            currentFollowersEl.textContent = count.toLocaleString('ru-RU');
            goalFollowersEl.textContent = (count + 1).toLocaleString('ru-RU');
        }

        function triggerRealSubscriberEvent(avatarUrl, nickname) {
            // –í—Å—Ç–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —Å TikTok
            subAvatarEl.src = avatarUrl || `https://api.dicebear.com/7.x/avataaars/svg?seed=${Math.random()}`;
            
            // –û–±—Ä–µ–∑–∞–µ–º –¥–ª–∏–Ω–Ω—ã–µ –∏–º–µ–Ω–∞, —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å –¥–∏–∑–∞–π–Ω
            if (nickname && nickname.length > 15) nickname = nickname.substring(0, 15) + '...';
            subNameEl.textContent = nickname || "–ù–æ–≤—ã–π –∑—Ä–∏—Ç–µ–ª—å";

            alertOverlay.classList.add('alert-active');
            
            currentFollowersEl.classList.remove('pop-animation');
            void currentFollowersEl.offsetWidth; 
            currentFollowersEl.classList.add('pop-animation');

            updateNumbers(currentCount);

            setTimeout(() => {
                alertOverlay.classList.remove('alert-active');
            }, 5000); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É 5 —Å–µ–∫—É–Ω–¥
        }

        function showPromoAnimation() {
            if (alertOverlay.classList.contains('alert-active')) return;
            promoAlert.classList.add('alert-active');
            setTimeout(() => {
                promoAlert.classList.remove('alert-active');
            }, 6000);
        }
    </script>
</body>
</html>
